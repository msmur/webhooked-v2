<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />
        <title>Webhook Inspector</title>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css  "
            rel="stylesheet"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js  "></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js  "></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css  " rel="stylesheet" />
        <style>
            :root {
                --primary: #4361ee;
                --primary-dark: #3a56d4;
                --secondary: #7209b7;
                --dark: #1a1a2e;
                --darker: #0d0d1a;
                --light: #f8f9fa;
                --gray: #6c757d;
                --light-gray: #e9ecef;
                --success: #4cc9f0;
                --border: #2d2d44;
                --card-bg: #16213e;
                --sidebar-bg: #0f3460;
                --hover-bg: #1e3a8a;
                --get-color: #4cc9f0; /* Blue for GET (read) */
                --post-color: #4ade80; /* Green for POST (create) */
                --put-color: #fbbf24; /* Yellow for PUT (update) */
                --delete-color: #ef4444; /* Red for DELETE (destroy) */
                --patch-color: #f59e0b; /* Orange for PATCH (partial update) */
                --head-color: #ec4899; /* Pink for HEAD (headers only) */
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, var(--darker), var(--dark));
                color: var(--light);
                height: 100vh;
                overflow: hidden;
            }

            .app-container {
                display: flex;
                height: 100vh;
                padding: 20px;
                gap: 20px;
            }

            /* Header Styles */
            .header {
                background: rgba(15, 52, 96, 0.7);
                backdrop-filter: blur(10px);
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                border: 1px solid var(--border);
            }

            .header h1 {
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 1.8rem;
                margin-bottom: 15px;
                color: var(--success);
            }

            .header h1 i {
                background: var(--primary);
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .hook-info {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }

            .info-card {
                background: rgba(22, 33, 62, 0.6);
                border-radius: 8px;
                padding: 15px;
                border: 1px solid var(--border);
            }

            .info-card h3 {
                font-size: 0.9rem;
                color: var(--success);
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .info-card p {
                font-size: 1.1rem;
                font-weight: 500;
            }

            /* Back Button */
            .back-button {
                background: var(--primary);
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                margin-left: auto;
            }

            .back-button:hover {
                background: var(--primary-dark);
                transform: translateY(-2px);
            }

            /* Panes Layout */
            #list-pane {
                width: 35%;
                display: flex;
                flex-direction: column;
                background: var(--sidebar-bg);
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                border: 1px solid var(--border);
            }

            #details-pane {
                flex-grow: 1;
                background: var(--card-bg);
                border-radius: 12px;
                padding: 25px;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                border: 1px solid var(--border);
            }

            /* Search and Filter Container */
            .search-filter-container {
                padding: 20px;
                background: rgba(10, 25, 47, 0.8);
                border-bottom: 1px solid var(--border);
            }

            .search-wrapper {
                position: relative;
                display: flex;
                gap: 10px;
                align-items: center;
            }

            #search-box {
                flex-grow: 1;
                border-radius: 8px;
                border: 1px solid var(--border);
                background: rgba(26, 26, 46, 0.7);
                color: var(--light);
                font-size: 1rem;
                padding: 12px 15px 12px 40px;
            }

            .search-filter-container i {
                position: absolute;
                margin: 12px 0 0 15px;
                color: var(--gray);
            }

            .method-filter {
                width: 120px;
                border-radius: 8px;
                border: 1px solid var(--border);
                background: rgba(26, 26, 46, 0.7);
                color: var(--light);
                font-size: 0.9rem;
                padding: 10px;
            }

            /* Webhook List */
            #webhook-list {
                flex-grow: 1;
                overflow-y: auto;
                padding: 10px;
            }

            .webhook-item {
                padding: 15px;
                margin-bottom: 10px;
                background: rgba(26, 26, 46, 0.5);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 1px solid transparent;
            }

            .webhook-item:hover {
                background: var(--hover-bg);
                transform: translateY(-2px);
                border-color: var(--primary);
            }

            .webhook-item.selected {
                background: var(--primary);
                border-color: var(--success);
                box-shadow: 0 0 15px rgba(67, 97, 238, 0.4);
            }

            .webhook-item.selected:hover {
                background: var(--primary-dark);
            }

            .webhook-id {
                font-weight: 600;
                margin-bottom: 5px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .webhook-id i {
                font-size: 0.9rem;
                color: var(--success);
            }

            .webhook-details {
                display: flex;
                justify-content: space-between;
                font-size: 0.85rem;
                color: var(--gray);
            }

            .webhook-date {
                font-style: italic;
            }

            .webhook-method {
                padding: 2px 8px;
                border-radius: 4px;
                font-weight: 600;
                font-size: 0.8rem;
                white-space: nowrap;
            }

            /* Color-coded method classes */
            .method-get {
                color: var(--get-color);
                background: rgba(76, 201, 240, 0.2);
            }

            .method-post {
                color: var(--post-color);
                background: rgba(74, 222, 128, 0.2);
            }

            .method-put {
                color: var(--put-color);
                background: rgba(251, 190, 36, 0.2);
            }

            .method-delete {
                color: var(--delete-color);
                background: rgba(239, 68, 68, 0.2);
            }

            .method-patch {
                color: var(--patch-color);
                background: rgba(245, 158, 11, 0.2);
            }

            .method-head {
                color: var(--head-color);
                background: rgba(236, 72, 153, 0.2);
            }

            /* Pagination */
            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 15px;
                background: rgba(10, 25, 47, 0.8);
                border-top: 1px solid var(--border);
            }

            .pagination button {
                background: var(--primary);
                color: white;
                border: none;
                padding: 8px 15px;
                margin: 0 5px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .pagination button:disabled {
                background: var(--gray);
                cursor: not-allowed;
            }

            .pagination button:hover:not(:disabled) {
                background: var(--primary-dark);
            }

            .pagination-info {
                margin: 0 15px;
                font-size: 0.9rem;
                color: var(--light-gray);
            }

            /* Details Pane */
            .details-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 1px solid var(--border);
            }

            .details-header h2 {
                font-size: 1.8rem;
                color: var(--success);
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .detail-section {
                margin-bottom: 30px;
            }

            .detail-section h3 {
                font-size: 1.2rem;
                margin-bottom: 15px;
                color: var(--success);
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .detail-section h3 i {
                font-size: 1.1rem;
            }

            .detail-content {
                background: rgba(10, 25, 47, 0.5);
                border-radius: 8px;
                padding: 20px;
                border: 1px solid var(--border);
            }

            .code-container {
                position: relative;
                border-radius: 8px;
                overflow: hidden;
                margin-top: 10px;
            }

            .copy-button {
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.5);
                color: white;
                border: none;
                padding: 8px 15px;
                font-size: 0.9rem;
                cursor: pointer;
                border-radius: 4px;
                transition: all 0.2s;
                z-index: 10;
            }

            .copy-button:hover {
                background: var(--primary);
            }

            pre[class*='language-'] {
                margin: 0;
                border-radius: 8px;
                max-height: 400px;
                overflow: auto;
            }

            /* Empty State */
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                text-align: center;
                padding: 20px;
                color: var(--gray);
            }

            .empty-state i {
                font-size: 4rem;
                margin-bottom: 20px;
                color: var(--primary);
            }

            .empty-state h3 {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
            }

            ::-webkit-scrollbar-track {
                background: rgba(10, 25, 47, 0.3);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--primary);
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--primary-dark);
            }

            /* Responsive */
            @media (max-width: 900px) {
                .app-container {
                    flex-direction: column;
                    height: auto;
                }

                #list-pane {
                    width: 100%;
                    height: 50vh;
                }

                .hook-info {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <div id="list-pane">
                <div class="header">
                    <div style="display: flex; align-items: center; justify-content: space-between">
                        <h1><i class="fas fa-plug"></i> Webhook Inspector</h1>
                        <button class="back-button" onclick="goBack()">
                            <i class="fas fa-arrow-left"></i> Back to Hooks
                        </button>
                    </div>
                    <div class="hook-info">
                        <div class="info-card">
                            <h3>Endpoint Name</h3>
                            <p id="hook-name">Loading...</p>
                        </div>
                        <div class="info-card">
                            <h3>Hook ID</h3>
                            <p id="hook-id">Loading...</p>
                        </div>
                        <div class="info-card">
                            <h3>Correlation Location</h3>
                            <p id="correlation-location">Loading...</p>
                        </div>
                        <div class="info-card">
                            <h3>Correlation Field</h3>
                            <p id="correlation-field">Loading...</p>
                        </div>
                    </div>
                </div>

                <div class="search-filter-container">
                    <div class="search-wrapper">
                        <i class="fas fa-search"></i>
                        <input id="search-box" placeholder="Search webhooks by correlation value..." type="text" />
                        <select class="method-filter" id="method-filter">
                            <option value="">All Methods</option>
                            <option class="method-get" value="GET">GET</option>
                            <option class="method-post" value="POST">POST</option>
                            <option class="method-put" value="PUT">PUT</option>
                            <option class="method-delete" value="DELETE">DELETE</option>
                            <option class="method-patch" value="PATCH">PATCH</option>
                            <option class="method-head" value="HEAD">HEAD</option>
                        </select>
                    </div>
                </div>

                <div id="webhook-list">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Loading Webhooks</h3>
                        <p>Please wait while we fetch your webhooks</p>
                    </div>
                </div>

                <div class="pagination">
                    <button disabled id="prev-page">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="pagination-info">
                        Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                    </div>
                    <button id="next-page">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div id="details-pane">
                <div class="empty-state">
                    <i class="fas fa-mouse-pointer"></i>
                    <h3>Select a Webhook</h3>
                    <p>Click on a webhook from the list to view its details</p>
                </div>
            </div>
        </div>

        <script>
            let allWebhooks = []; // Store all loaded webhooks for current page
            let hook = null;
            let existingSearchTerm = null;
            let existingMethodFilter = null;
            let currentPage = 1;
            const limit = 20;
            let hookId = null; // Will be set from URL or API
            let selectedWebhookId = null;
            let totalPages = 1;

            function formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true,
                });
            }

            function debounce(func, delay) {
                let timer;
                return function (...args) {
                    clearTimeout(timer);
                    timer = setTimeout(() => func.apply(this, args), delay);
                };
            }

            function showDetails(webhookId) {
                const detailsPane = document.getElementById('details-pane');
                const webhook = allWebhooks.find((w) => w.id === webhookId);

                if (webhook) {
                    document.querySelectorAll('.webhook-item').forEach((item) => {
                        item.classList.remove('selected');
                    });
                    document.querySelector(`.webhook-item[data-webhook-id="${webhookId}"]`).classList.add('selected');

                    selectedWebhookId = webhookId;

                    // Determine method color class
                    const methodClass = `method-${webhook.method?.toLowerCase() || ''}`;

                    detailsPane.innerHTML = `
                    <div class="details-header">
                        <h2><i class="fas fa-info-circle"></i> Webhook Details</h2>
                    </div>

                    <div class="detail-section">
                        <h3><i class="fas fa-info-circle"></i> Request Information</h3>
                        <div class="detail-content">
                            <p><strong>ID:</strong> ${webhook.id}</p>
                            <p><strong>Method:</strong> <span class="webhook-method ${methodClass}">${webhook.method || 'N/A'}</span></p>
                            <p><strong>Timestamp:</strong> ${formatDate(webhook.created_at)}</p>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3><i class="fas fa-fingerprint"></i> Correlation Value</h3>
                        <div class="detail-content">
                            <p>${webhook.correlation_value || 'N/A'}</p>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3><i class="fas fa-question-circle"></i> Query Parameters</h3>
                        ${createCodeBlock('Query String', webhook.query)}
                    </div>

                    <div class="detail-section">
                        <h3><i class="fas fa-envelope-open-text"></i> Payload</h3>
                        ${createCodeBlock('Payload', webhook.payload)}
                    </div>

                    <div class="detail-section">
                        <h3><i class="fas fa-code"></i> Headers</h3>
                        ${createCodeBlock('Headers', webhook.headers)}
                    </div>
                `;
                }

                Prism.highlightAll();
            }

            async function loadWebhooks(page = 1, inputSearch = null, methodFilter = null) {
                const offset = (page - 1) * limit;

                try {
                    let url = `/api/hooks/${hookId}/webhooks?offset=${offset}&limit=${limit}`;

                    if (inputSearch) {
                        url += `&search=${encodeURIComponent(inputSearch)}`;
                    }

                    if (methodFilter) {
                        url += `&method=${encodeURIComponent(methodFilter)}`;
                    }

                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Failed to fetch webhooks');
                    }

                    const result = await response.json();

                    allWebhooks = result.data;
                    totalPages = Math.ceil(result.total / limit);
                    currentPage = totalPages === 0 ? 0 : page;

                    const listPane = document.getElementById('webhook-list');

                    // Show empty state if no webhooks
                    if (allWebhooks.length === 0) {
                        listPane.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No Webhooks Found</h3>
                            <p>No webhooks match your search criteria</p>
                        </div>
                    `;
                        updatePagination();
                        return;
                    }

                    listPane.innerHTML = '';
                    allWebhooks.forEach((webhook) => {
                        const item = document.createElement('div');
                        item.classList.add('webhook-item');
                        item.setAttribute('data-webhook-id', webhook.id);
                        item.setAttribute('data-correlation-value', webhook.correlation_value || '');

                        // Determine method color class
                        const methodClass = `method-${webhook.method?.toLowerCase() || ''}`;

                        item.innerHTML = `
                        <div class="webhook-id">
                            <i class="fas fa-bolt"></i>
                            <span class="webhook-method ${methodClass}">${webhook.method || 'N/A'}</span>
                            ${webhook.id}
                        </div>
                        <div class="webhook-details">
                            <span class="webhook-correlation">${webhook.correlation_value || 'N/A'}</span>
                            <span class="webhook-date">${formatDate(webhook.created_at)}</span>
                        </div>
                    `;
                        item.addEventListener('click', () => showDetails(webhook.id));
                        listPane.appendChild(item);
                    });

                    updatePagination();

                    // Auto-select first webhook if none selected
                    if (!selectedWebhookId && allWebhooks.length > 0) {
                        showDetails(allWebhooks[0].id);
                    }
                } catch (error) {
                    console.error('Error loading webhooks:', error);
                    const listPane = document.getElementById('webhook-list');
                    listPane.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Webhooks</h3>
                        <p>Failed to load webhooks. Please try again later.</p>
                    </div>
                `;
                }
            }

            function updatePagination() {
                document.getElementById('current-page').textContent = currentPage;
                document.getElementById('total-pages').textContent = totalPages;
                document.getElementById('prev-page').disabled = currentPage <= 1;
                document.getElementById('next-page').disabled = currentPage === totalPages;
            }

            async function searchWebhooks() {
                currentPage = 1; // Reset to first page on search
                const searchTerm = document.getElementById('search-box').value.trim() || null;
                const methodFilter = document.getElementById('method-filter').value || null;
                existingSearchTerm = searchTerm;
                existingMethodFilter = methodFilter;
                await loadWebhooks(currentPage, searchTerm, methodFilter);
            }

            const debouncedSearch = debounce(searchWebhooks, 300);

            function createCodeBlock(title, jsonData) {
                const jsonString = JSON.stringify(jsonData, null, 2);
                return `
                <div class="code-container">
                    <button class="copy-button" onclick="copyToClipboard(this)">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <pre><code class="language-json">${jsonString}</code></pre>
                </div>
            `;
            }

            function copyToClipboard(button) {
                const codeBlock = button.nextElementSibling.textContent; // Get JSON text
                navigator.clipboard
                    .writeText(codeBlock)
                    .then(() => {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => (button.innerHTML = originalText), 2000); // Reset text after 2s
                    })
                    .catch((err) => {
                        console.error('Failed to copy text: ', err);
                    });
            }

            // Extract hook ID from URL path (e.g., /hooks/123/webhooks)
            function getHookIdFromUrl() {
                const pathParts = window.location.pathname.split('/');
                const hooksIndex = pathParts.indexOf('hooks');
                if (hooksIndex !== -1 && pathParts[hooksIndex + 1]) {
                    return pathParts[hooksIndex + 1];
                }
                return '1'; // Default fallback
            }

            // Load hook details to get the name
            async function loadHookDetails() {
                try {
                    const response = await fetch(`/api/hooks/${hookId}`);
                    if (response.ok) {
                        const hook = await response.json();
                        document.getElementById('hook-name').textContent = hook.name;
                        document.getElementById('hook-id').textContent = hook.id;
                        document.getElementById('correlation-location').textContent =
                            hook.correlation_identifier_location || 'N/A';
                        document.getElementById('correlation-field').textContent =
                            hook.correlation_identifier_field || 'N/A';
                    } else {
                        throw new Error('Failed to load hook details');
                    }
                } catch (error) {
                    console.error('Error loading hook details:', error);
                    document.getElementById('hook-name').textContent = `Hook ${hookId}`;
                }
            }

            // Go back to hooks view
            function goBack() {
                window.location.href = '/';
            }

            document.addEventListener('DOMContentLoaded', async () => {
                // Get hook ID from URL or use default
                hookId = getHookIdFromUrl();

                // Load hook details
                await loadHookDetails();

                // Set up pagination buttons
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (currentPage > 1) {
                        loadWebhooks(currentPage - 1, existingSearchTerm, existingMethodFilter);
                    }
                });

                document.getElementById('next-page').addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        loadWebhooks(currentPage + 1, existingSearchTerm, existingMethodFilter);
                    }
                });

                // Set up search
                document.getElementById('search-box').addEventListener('input', debouncedSearch);

                // Set up method filter
                document.getElementById('method-filter').addEventListener('change', searchWebhooks);

                // Load initial webhooks
                await loadWebhooks(currentPage);
            });
        </script>
    </body>
</html>
